name: Deploy to AWS (Main)

on:
    push:
        branches: [main]

env:
    GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    GAR_LOCATION: ${{ secrets.GAR_LOCATION }}
    SERVICE_NAME: loga
    AWS_INSTANCE_HOST: ${{ secrets.AWS_INSTANCE_HOST }}

jobs:
    build-and-deploy:
        name: Build and Deploy to AWS (Main)
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/aws_key
                  chmod 600 ~/.ssh/aws_key
                  ssh-keyscan -H "${{ secrets.AWS_INSTANCE_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

            - name: Build and Deploy on EC2 (Native ARM64)
              env:
                  GAR_LOCATION: ${{ env.GAR_LOCATION }}
                  GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
                  SERVICE_NAME: ${{ env.SERVICE_NAME }}
                  COMMIT_SHA: ${{ github.sha }}
              run: |
                  ssh -i ~/.ssh/aws_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.AWS_INSTANCE_HOST }} "
                  set -e
                  export GAR_LOCATION='$GAR_LOCATION'
                  export GCP_PROJECT_ID='$GCP_PROJECT_ID'
                  export SERVICE_NAME='$SERVICE_NAME'
                  export COMMIT_SHA='$COMMIT_SHA'

                  cd /home/ubuntu/loga || exit 1

                  echo '=== Pulling latest code ==='
                  git fetch origin main
                  git reset --hard origin/main

                  echo '=== Building Docker image (Native ARM64) ==='
                  docker build -t loga-backend:\$COMMIT_SHA -t loga-backend:latest .

                  echo '=== Pushing to Artifact Registry ==='
                  gcloud auth activate-service-account --key-file=/home/ubuntu/gcp-service-account.json --quiet
                  gcloud auth configure-docker \$GAR_LOCATION --quiet
                  IMAGE_TAG=\"\$GAR_LOCATION/\$GCP_PROJECT_ID/\$SERVICE_NAME/loga-backend:\$COMMIT_SHA\"
                  docker tag loga-backend:\$COMMIT_SHA \"\$IMAGE_TAG\"
                  docker push \"\$IMAGE_TAG\"

                  echo '=== Running Blue-Green deployment ==='
                  bash deploy.sh \$COMMIT_SHA

                  echo '=== Cleanup ==='
                  docker image prune -f

                  echo '=== Deployment completed ==='
                  "
